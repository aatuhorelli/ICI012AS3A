# H2 - Break and unbreak

Tehtävänannot luettavissa https://terokarvinen.com/application-hacking/.

Tehtävissä käytetty laitteisto:
 ````
Isäntälaite: Macbook Pro
 Käyttöjärjestelmä: macOS Sequoia 15.1
 Prosessori: M1 Pro (Apple silicon)
 RAM: 16GB

Virtuaalikoneen tiedot:
 OS: Debian 12 Bookworm
 RAM: 4GB 
 Virtualisointi: UTM
````

## x) Lue ja tiivistä

### OWASP: OWASP Top 10: A01 Broken Access Control

 - Broken Access Control on OWASP Top 10 -haavoittuvuuslistauksen kärkipaikalla
 - Pääsynhallinnan tarkoituksena on sallia käyttäjien toimet vain omien oikeuksiensa puitteissa
   - Epäonnistuessaan mahdollistaa tiedon vuotamisen, muuttumisen tai poistamisen, sekä käyttöoikeuksien ulkopuolisten toimintojen käytön
 - Yleisimmät pääsynhallinnan haavoittuvuudet:
   - Least privilege ja deny by default -periaatteiden noudattamatta jättäminen
   - Rajapinnat (API) liittyvät haavoittuvuudet:
     - POST, UPDATE ja DELETE puutteelliset käyttöoikeudet
     - API-pyyntöjen muokkaus hyökkäystyökaluja hyödyntämällä
   - IDOR(Insecure Direct Object References). Tietoihin pääsee suoraan käsiksi viittauksia muuttamalla.
 - Ennaltaehkäisy:
   - Toimii vain, jos hyökkääjän toimet estetään palvelinpään käsittelyllä tai rajapinnassa
   - Deny by default: kaikki pyynnöt hylätään oletusarvoisesti, jos vaadittuja oikeuksia niiden katseluun ei ole
   - Samojen pääsynhallintamekanismien hyödyntäminen sovelluksen eri osa-alueilla
   - Tiedon omistajuuden määrittely CRUDin sijaan
   - Web-palvelimen hakemistolistauksen estäminen
   - Asianmukainen lokitus ja hälytykset pääsynhallinnan virheistä
   - Liikenteen rajoittaminen rajapinnoissa automaattisten työkalujen käytön vaikeuttamiseksi
   - Istuntojen tunnisteiden invalidointi uloskirjautumisen yhteydessä. JWT-tokenien elinaika pidettävä tarpeeksi lyhyenä.
  
  Lähde: OWASP: OWASP Top 10: A01 Broken access control. https://owasp.org/Top10/A01_2021-Broken_Access_Control/

### Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf

- Fuff on joohoin kehittämä web-fuzzeri, jolla voi fuzzata mm.:
   - Palvelinten piilotetut hakemistot
   - Headerit
   - POST-parametrit

 - Tero Karvisen harjoitusmaalin(dirfuzt-0) lataus ja käynnistäminen:
   ````   
    $ wget https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/dirfuzt-0
    $ chmod u+x dirfuzt-0
    $ ./dirfuzt-0
    Learn more at TeroKarvinen.com
    http://127.0.0.2:8000
   ````
 - Fuff lataus, purkaminen ja käynnistys:
   ````
   $ wget https://github.com/ffuf/ffuf/releases/download/v2.0.0/ffuf_2.0.0_linux_amd64.tar.gz
   $ tar -xf ffuf_2.0.0_linux_amd64.tar.gz
   $ ./ffuf
   Fuzz Faster U Fool - v2.0.0
   ````
 - Sanalistojen lataus (esim. Daniel Miesslerin Seclists): ``$ wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt``
 - Fuff käyttö: ``$ ./fuff -w common.txt -u http://127.0.0.2:8000/FUZZ``
   - ``./fuff``: ajaa fuffin työhakemistosta
   - ``-w common.txt``: käytettävä sanalista. Oma huomio: omaan muuttujaansa määrittely myös mahdollista, esim. ``-w common.txt:PASSWORD``
   - ``-u http://127.0.0.2:8000/FUZZ``: Fuzzauksen kohde on ip-osoite 127.0.0.2 portissa 8000. 'FUZZ' korvataan sanalistan sanoilla yksi kerrallaan. 
 - Hyödyllisiä parametreja tulosten suodattamiseen:
   - ``-fc``: HTTP status, esim 200
   - ``-fs``: vastauksen koko tavuina. Esimerkkikäyttö: ``$ ./ffuf -w common.txt -u http://127.0.0.2:8000/FUZZ -fs 132`` poistaa tuloksista 132 tavun kokoiset osumat.
   - ``-fw``: Sanojen määrä.
   - ``-fl``: Rivien määrä.
   - ``-ft``: Vastauksen viive millisekunteina.
  
- Hyödyllisiä linkkejä:
  - Fuff kotisivu: https://github.com/ffuf/ffuf
  - Lisää sanalistoja:
    - MiessLer, Haddix, g0tmi1k: SecLists: https://github.com/danielmiessler/SecLists
      
Lähde: Terokarvinen.com. https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/

### PortSwigger: Access control vulnerabilities and privilege escalation

 - Pääsynhallinta (=access control) määrittää kenellä tai millä on pääsy resursseihin tai tietoon.
 - Monimutkainen suunnitella ja toteuttaa --> altis virheille. Haavoittuvuudet yleisiä.
 - Pääsynhallinta web-sovellusten kontekstissa koostuu:
   - Autentikoinnista: varmistetaan, että käyttäjä on se, joka väittää olevansa
   - Istuntojen hallinnasta (=session management): varmistaa, että peräkkäiset HTTP-pyynnöt tulevat samalta käyttäjältä
   - Pääsynhallinnasta: tarkistetaan, onko käyttäjällä oikeus suorittaa haluamansa toiminto
 - Pääsynhallinnan kontrolleja:
   - Vertikaalinen: Rajoittaa toimintoja, joita eri tason käyttäjät voivat suorittaa. Esim. admin vs peruskäyttäjä.
     - Esimerkkihaavoittuvuus: peruskäyttäjä pääsee admin-sivulle suorittamaan admin-tason toimintoja.
   - Horisontaalinen: Rajoittaa pääsyn vain käyttäjälle sallittuihin resursseihin. Esim. pankkitilit.
     - Esimerkkihaavoittuvuus: Työntekijä voi tarkastella toisen työntekijän käyttöön rajoitettuja tietoja.
     - Voi toimia siltana vertical privilege escalationille, jossa saadaan tätä kautta käyttöön korkeammilla oikeuksilla varustettu käyttäjätunnus.
   - Kontekstiriippuvainen: Rajoittaa toimintojen käytön vain tiettyihin vaiheisiin sovelluksen käytössä. Esim. ostoskorin muokkaus estetty verkkokaupassa maksamisen jälkeen.

Lähde: PortSwigger: Access control vulnerabilities and privilege escalation. https://portswigger.net/web-security/access-control

### Karvinen 2006: Raportin kirjoittaminen

 - Hyvin jäsennelty raportti on tehokas tapa kirjata muistiin toimenpiteiden eri työvaiheita ja tuloksia.
 - Raportit soveltuvat myös pohjaksi toisille käyttäjille laadittaville ohjeistuksille.
 - Raportti:
     - On toistettava: samassa ympäristössä raportin pohjalta toistetun toimenpiteen tulee päätyä samaan lopputulokseen.
     - On täsmällinen: raportoi komennot, klikkaukset, kellonajat. Käytä aikamuotona imperfektiä. Testaa toiminta, raportoi miten. Raportoi myös odottamattomat tulokset ja epäonnistumiset. Tarvittaessa tee työkaluista tai koneista vikailmoitus asianmukaiselle taholle.
     - On helppolukuinen: kirjoita huolellisesti ja kanavaan sopivalla tavalla. Käytä väliotsikoita.
     - Viittaa lähteisiin: viittaus alkuperäiseen tekstiin on hyvän tavan ja akateemisen käytännön mukaista, sekä osoittaa kirjoittajan perehtyneen aihealueeseen
 - Mokia:
     - Sepittäminen: raportoi vain tekemiäsi töitä ja testejä. Sepitetyn raportin toistamiseen tuhrautuu aikaa.
     - Plagiointi: Muiden tuotosten (teksti, kuvat, testitulokset) esittäminen ominaan loukkaa tekijänoikeuksia.

Lähde: Terokarvinen.com. https://terokarvinen.com/2006/raportin-kirjoittaminen-4/

## a) Murtaudu 010-staff-only

Sain 010-staff-only korkattua ja korjattua jo tunnilla, joten raportti kirjoitettu osittain ulkomuistista.



For the report, explain

Environment
OS, browser, hardware, network
Any precautions taken
For example: if using automated crawlers and fuzzers you're not familiar yet, disconnecting Internet when running the tools.
Hack
What methods you used for testing the applications (successfull and unsuccesfull).
What the vulnerability is?
How to exploit the vulnerability and how each part of your exploit work.
Refer all documentation and sources you used
Fix
Which area of code has the mistake
What the mistake is? Do you have a guess how programmer has made this mistake?
How does your fix work?
Does your fix have any downsides? Any areas that should be checked or explored in the future?
Refer all documentation and sources you used
Reflect
What kind of targets could have this type of vulnerability?
Is this likely to be common or realistic scennario?
How could this vulnerability be avoided?
Any other lessons learned.

## b) Korjaa 010-staff-only haavoittuvuus lähdekoodista. Osoita testillä, että ratkaisusi toimii.

## c) Dirfuzt-1

Olin asentanut virtuaalikoneelle ffuf:n jo aiemmin, joten en tässä raportissa käsitellyt asennuksen eri vaiheita. 

## d) Murtaudu 020-your-eyes-only

## e) Korjaa 020-your-eyes-only haavoittuvuus

## Lähteet:

Karvinen 2024: New Course: Application Hacking. Luettavissa https://terokarvinen.com/application-hacking/. Luettu 30.10.2024.
OWASP: OWASP Top 10: A01 Broken access control. Luettavissa https://owasp.org/Top10/A01_2021-Broken_Access_Control/. Luettu 30.10.2024.
Karvinen 2023: Find Hidden Web Directories - Fuzz URLs with ffuf. Luettavissa https://terokarvinen.com/2023/fuzz-urls-find-hidden-directories/. Luettu 30.10.2024.
PortSwigger: Access control vulnerabilities and privilege escalation. Luettavissa https://portswigger.net/web-security/access-control. Luettu 30.10.2024.
Karvinen 2006: Raportin kirjoittaminen. Luettavissa https://terokarvinen.com/2006/raportin-kirjoittaminen-4/. Luettu 30.10.2024.
Karvinen 2024: Hack 'n fix. Luettavissa https://terokarvinen.com/hack-n-fix/. Luettu 30.10.2024.

